<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shop â€” Malgax</title>
  <style>
    body{margin:0;background:#0f0f14;color:#e9e9f4;font:15px system-ui,Segoe UI,Roboto,Arial}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#14141c;border-bottom:1px solid rgba(255,255,255,.1)}
    .pill{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);padding:6px 10px;border-radius:999px}
    .coin{width:14px;height:14px;border-radius:50%;display:inline-block;background:radial-gradient(90% 90% at 30% 30%, #fff4a6 0%, #ffd94d 35%, #e0a300 60%, #b07b00 100%);box-shadow:inset 0 0 0 1px rgba(0,0,0,.25),0 1px 4px rgba(0,0,0,.35)}
    .btn{border:0;background:#6441a5;color:#fff;font-weight:800;border-radius:10px;padding:8px 12px;cursor:pointer}
    main{max-width:1100px;margin:18px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
    @media (max-width:980px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    .card{background:#16161f;border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{aspect-ratio:2/3;background:#0b0b10;display:flex;align-items:center;justify-content:center}
    .thumb img{width:100%;height:100%;object-fit:contain}
    .info{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .muted{color:#a4a4b5}
  </style>
</head>
<body>
  <header>
    <strong>ðŸ›’ Shop</strong>
    <div id="userPill" class="pill" style="display:none">
      <span id="userName">â€”</span>
      <span class="coin"></span>
      <span id="userUnspent">0</span>
    </div>
    <button id="btnAuth" class="btn">Accedi</button>
  </header>

  <main>
    <p class="muted">Compra carte usando i tuoi punti.</p>
    <div id="grid" class="grid"></div>
  </main>

  <script>
    const API="https://api.malgax.com";
    const LOGIN=API+"/auth/twitch?popup=1";
    const LOGOUT=API+"/logout?popup=1";

    const pill=document.getElementById('userPill');
    const nameEl=document.getElementById('userName');
    const ptsEl=document.getElementById('userUnspent');
    const btn=document.getElementById('btnAuth');
    const grid=document.getElementById('grid');
    let logged=false, pop=null;

    const setBtn=()=>btn.textContent=logged?'Logout':'Accedi';
    async function me(){
      try{ const r=await fetch(API+'/me',{credentials:'include'}); if(!r.ok) return null; return await r.json(); }catch(_){ return null; }
    }
    async function paintMe(){
      const m=await me();
      if(m){ nameEl.textContent=m.username||'Utente'; ptsEl.textContent=m.unspent_points??0; pill.style.display='flex'; logged=true; }
      else { pill.style.display='none'; logged=false; }
      setBtn();
    }

    function openPop(u){ pop=window.open(u,'auth','width=640,height=760'); }
    btn.addEventListener('click', async ()=>{
      if(!logged){ openPop(LOGIN); const ok=await waitLogin(); if(ok) paintMe(); }
      else{ openPop(LOGOUT); setTimeout(()=>{ try{pop&&pop.close()}catch(_){}} ,1500); logged=false; setBtn(); pill.style.display='none'; }
    });
    window.addEventListener('message',ev=>{ if(ev.origin===API && ev.data?.type==='login'){ paintMe(); try{pop&&pop.close()}catch(_){}} });
    async function waitLogin(t=15000){ const s=Date.now(); while(Date.now()-s<t){ const m=await me(); if(m) return true; await new Promise(r=>setTimeout(r,600)); } return false; }

    async function load(){
      paintMe();
      const r=await fetch(API+'/shop/items',{credentials:'include'}); const items=await r.json();
      grid.innerHTML='';
      items.forEach(it=>{
        const el=document.createElement('div'); el.className='card';
        el.innerHTML=`
          <div class="thumb"><img src="${it.image_url}" alt="${it.name}"></div>
          <div class="info">
            <div><div>${it.name}</div><div class="muted">${it.kind} Â· ${it.cost_points} pt</div></div>
            <button class="btn">Compra</button>
          </div>`;
        el.querySelector('.btn').addEventListener('click', async ()=>{
          if(!logged){ openPop(LOGIN); const ok=await waitLogin(); if(!ok) return; }
          const res=await fetch(API+'/shop/purchase',{
            method:'POST',credentials:'include',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({item_id:it.id,quantity:1})
          });
          if(res.status===401){ openPop(LOGIN); return; }
          const j=await res.json();
          if(!res.ok){ alert('Errore: '+(j.error||'purchase_failed')); return; }
          alert(`Acquistato: ${it.name} (-${it.cost_points} pt)`);
          paintMe();
        });
        grid.appendChild(el);
      });
    }
    load();
  </script>
</body>
</html>
