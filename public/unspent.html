<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Punti non spesi — Malgax</title>
  <style>
    :root{
      --bg:#0f0f14; --card:#16161f; --text:#f4f4f7; --muted:#a4a4b5; --line:#2a2a36; --twitch:#6441a5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg); color:var(--text);
    }
    .wrap{min-height:100%; display:flex; align-items:flex-start; justify-content:center; padding:16px}
    .card{ width:100%; max-width:900px; background:var(--card); border:1px solid rgba(255,255,255,.08);
      border-radius:14px; overflow:hidden; box-shadow:0 8px 28px rgba(0,0,0,.35) }
    .head{ padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:space-between; gap:10px }
    .title{ margin:0; font-size:18px; font-weight:800 }
    .status{ font-size:13px; color:var(--muted) }
    .panel{ padding:10px 12px 16px; /* overflow set dynamically when >20 righe */ }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:10px 8px; text-align:left; border-bottom:1px solid rgba(255,255,255,.06); }
    th{ font-size:13px; color:#d6d6e8; letter-spacing:.2px; }
    td{ font-size:14px; }
    .rank{ width:70px; color:#cfcff0; font-variant-numeric:tabular-nums; }
    .user{ font-weight:700 }
    .pts{ text-align:right; font-variant-numeric:tabular-nums; }
    .empty, .err{ padding:14px; color:var(--muted); }
    .chip{ display:inline-flex; gap:8px; align-items:center; font-size:12px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.1); padding:6px 8px; border-radius:999px; }
    .dot{ width:8px; height:8px; border-radius:50%; background:#39d353; box-shadow:0 0 0 2px rgba(57,211,83,.2) }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <h1 class="title">Punti non spesi</h1>
        <div id="status" class="status"><span class="chip"><span class="dot"></span> live</span></div>
      </div>
      <div id="panel" class="panel">
        <div class="empty">Caricamento…</div>
      </div>
    </div>
  </div>

  <script>
    const API = location.origin.includes('api.malgax.com') ? location.origin : 'https://api.malgax.com';

    function applyScrollIfNeeded(panel, table, rowsCount){
      if(rowsCount > 20){
        const tr = table.tBodies[0]?.rows[0];
        const th = table.tHead;
        const rowH = tr ? tr.getBoundingClientRect().height : 38;
        const headH = th ? th.getBoundingClientRect().height : 40;
        const maxH = Math.ceil(headH + (rowH * 20) + 16);
        panel.style.maxHeight = maxH + 'px';
        panel.style.overflowY = 'auto';
      } else {
        panel.style.maxHeight = '';
        panel.style.overflowY = '';
      }
    }

    async function loadUnspent(){
      const panel = document.getElementById('panel');
      try{
        const res = await fetch(`${API}/api/leaderboard/unspent`, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        let data = await res.json();
        data = Array.isArray(data) ? data.filter(r => Number(r.points) > 0) : [];
        if(data.length===0){
          panel.innerHTML = '<div class="empty">Nessun dato in classifica.</div>';
          return;
        }
        const rows = data.map((r,i)=>`
          <tr>
            <td class="rank">${String(i+1).padStart(2,'0')}</td>
            <td class="user">${(r.username||'Utente')}</td>
            <td class="pts">${Number(r.points||0)}</td>
          </tr>`).join('');
        panel.innerHTML = `
          <table aria-label="Punti non spesi">
            <thead><tr><th>#</th><th>Utente</th><th style="text-align:right">Punti</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
        const table = panel.querySelector('table');
        applyScrollIfNeeded(panel, table, data.length);
      }catch(e){
        console.error('Unspent error:', e);
        panel.innerHTML = '<div class="err">Errore nel caricamento della classifica.</div>';
      }
    }
    loadUnspent();
  </script>
</body>
</html>
